<?php
// $Id$

/**
 * @file
 *
 * Enables mautic tracker
 */

/**
 * Define default path exclusion list to remove tracking from admin pages.
 */
define('MAUTIC_PAGES', "admin\nadmin/*\nbatch\nnode/add*\nnode/*/*\nuser/*/*");

/**
 * Implements hook_help().
 *
 * Displays help and module information.
 *
 * @param path
 *   Which path of the site we're using to display help
 * @param arg
 *   Array that holds the current path as returned from arg() function
 */
function mautic_help($path, $arg) {
  switch ($path) {
    case "admin/help#mautic":
      $output = '<h3>' . t("Mautic integration") . '</h3>';
      $output .= '<p>' . t('This Drupal module lets you add the <a href="@mautic">Mautic</a> tracking gif to your Drupal website and embed Mautic forms in Drupal content.', array('@mautic' => 'http://mautic.org')) . '</p>';
      $output .= '<h3>' . t('Features') . '</h3>';
      $output .= '<dl>';
      $output .= '<dt>' . t('Mautic Tracking') . '</dt>';
      $output .= '<dd>' . t('Tracking image works right after you enable the module, insert Base URL and save the plugin. That means it will insert 1 px gif image loaded from your Mautic instance. You can check HTML source code (CTRL + U) of your Drupal website to make sure the plugin works. You should be able to find something like this:<br><code>&lt;img src="http://yourmautic.com/mtracking.gif" /&gt;</code><br>There will be probably longer URL query string at the end of the tracking image URL. It is encoded additional data about the page (title, url, referrer, language).') . '</dd>';
      $output .= '<dt>' . t('Form embed') . '</dt>';
      $output .= '<dd>' . t("To embed a Mautic form into Drupal content, insert this code snippet:<br><code>{mauticform id=ID width=300px height=300px}</code><br>ID is the identifier of the Mautic form you want to embed. You can see the ID of the form in the URL of the form detail. For example for www.yourmautic.com/forms/view/1, ID = 1.") . '</dd>';
      $output .= '</dl>';
      $output .= '<p>' . t('Mautic-Drupal module <a href="@doc">documentation</a>, <a href="@issues">issue reporting</a>', array('@doc' => 'https://github.com/mautic/mautic-drupal/tree/7.x#readme', '@issues' => 'https://github.com/mautic/mautic-drupal/issues')) . '</p>';

      return $output;
      break;
  }
}

/**
 * Implements hook_page_alter() to insert JavaScript to the appropriate scope/region of the page.
 */
function mautic_page_alter(&$page) {
  $mautic_base_url = variable_get('mautic_base_url', '');
  $script = <<<JS
    (function(w,d,t,u,n,a,m){w['MauticTrackingObject']=n;
        w[n]=w[n]||function(){(w[n].q=w[n].q||[]).push(arguments)},a=d.createElement(t),
        m=d.getElementsByTagName(t)[0];a.async=1;a.src=u;m.parentNode.insertBefore(a,m)
    })(window,document,'script','{$mautic_base_url}/mtc.js','mt');
    mt('send', 'pageview');
JS;
  drupal_add_js($script, array('scope' => 'header', 'type' => 'inline', 'requires_jquery' => FALSE));
}

/**
 * Implementation of hook_filter_info()
 */
function mautic_filter_info() {
  $filters['mautic_shortcode'] = array(
    'title' => t('Mautic Shortcodes'),
    'description' => t('Sets up a custom filter that helps create mautic artifacts.'),
    'process callback' => 'mautic_filter_shortcodes_process',
    'tips callback'  => 'mautic_filter_shortcodes_tips',
    'cache' => FALSE,
  );
  return $filters;
}

function mautic_filter_shortcodes_process($text, $filter, $format, $langcode, $cache, $cache_id) {
  return preg_replace_callback('/\[mauticform id=(.*)\]/', '_mautic_filter_replace', $text);
}

function mautic_filter_shortcodes_tips($filter, $format, $long) {
  return t('[mauticform id=1] - Insert a Mautic form with given ID.');
}

function _mautic_filter_replace($matches) {
  $form_id = $matches[1];
  $mautic_base_url = variable_get('mautic_base_url', '');
  $args = array('@mautic_base_url' => $mautic_base_url, '@form_id' => $form_id);
  $script = format_string('<script src="@mautic_base_url/form/generate.js?id=@form_id"></script>', $args);
  return $script;
}

/**
 * Implements hook_menu().
 */
function mautic_menu() {
  $items = array();

  $items['admin/config/mautic'] = array(
    'title' => 'Mautic URL',
    'description' => 'Configuration for Current posts module',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('mautic_form'),
    'access arguments' => array('access administration pages'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

function mautic_form() {
  $form = array();

  $form['mautic_base_url'] = array(
    '#type' => 'textfield',
    '#title' => t('Mautic URL'),
    '#default_value' => variable_get('mautic_base_url', ''),
    '#size' => 60,
    '#description' => t("Your mautic base url."),
    '#required' => TRUE,
  );

  return system_settings_form($form);
}
